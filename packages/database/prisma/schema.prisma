generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String          @id @default(uuid()) @db.Uuid
  privyUserId    String          @unique @map("privy_user_id") @db.VarChar(255)
  walletAddress  String?         @unique @map("wallet_address") @db.VarChar(42)
  isDelegated    Boolean         @default(false)
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  budgetSettings BudgetSettings?
  conversations  Conversation[]

  @@map("users")
}

model BudgetSettings {
  userId               String   @id @map("user_id") @db.Uuid
  dailyLimit           Decimal  @default(100) @map("daily_limit") @db.Decimal(18, 6)
  autoApproveThreshold Decimal  @default(1) @map("auto_approve_threshold") @db.Decimal(18, 6)
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("budget_settings")
}

model Transaction {
  id           String            @id @default(uuid()) @db.Uuid
  walletId     String?           @map("wallet_id") @db.VarChar(255)
  agentId      String            @map("agent_id") @db.VarChar(66)
  amount       Decimal           @map("amount") @db.Decimal(18, 6)
  txHash       String            @unique @map("tx_hash") @db.VarChar(66)
  status       TransactionStatus  @default(PENDING)
  createdAt    DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([walletId])
  @@map("transactions")
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

/// On-chain AgentCard のキャッシュ（Alchemy Webhookで同期）
model AgentCache {
  agentId          String   @id @map("agent_id") @db.VarChar(66)
  owner            String?  @map("owner") @db.VarChar(42)
  category         String?  @map("category") @db.VarChar(64)
  isActive         Boolean? @map("is_active")
  agentCard        Json     @map("agent_card")
  lastSyncedBlock  Int      @default(0) @map("last_synced_block")
  lastSyncedLogIdx Int      @default(0) @map("last_synced_log_idx")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([category])
  @@index([owner])
  @@index([isActive])
  @@map("agent_cache")
}

model AccessLimit {
  id            String   @id @default(uuid()) @db.Uuid
  identifier    String   @map("identifier") @db.VarChar(255)
  identifierType String  @map("identifier_type") @db.VarChar(20) // 'ip' | 'wallet'
  feature       String   @map("feature") @db.VarChar(50)
  firstRequestAt DateTime @map("first_request_at") @db.Timestamptz(6)
  requestCount  Int      @default(0) @map("request_count")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([identifier, identifierType, feature], name: "idx_identifier_type_feature")
  @@index([identifier])
  @@index([identifierType])
  @@index([feature])
  @@map("access_limits")
}

model Conversation {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  title     String?   @db.VarChar(200)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @map("conversation_id") @db.Uuid
  role           MessageRole
  content        String       @db.Text
  totalCost      Decimal?     @map("total_cost") @db.Decimal(18, 6)
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

enum MessageRole {
  user
  assistant
}

/// EAS オフチェーンアテステーション（エージェント評価結果）
model EasAttestation {
  id          String   @id @default(uuid()) @db.Uuid
  agentId     String   @map("agent_id") @db.VarChar(66)
  schemaUid   String   @map("schema_uid") @db.VarChar(66)
  attestation Json     @map("attestation")
  attester    String   @map("attester") @db.VarChar(42)
  paymentTx   String?  @map("payment_tx") @db.VarChar(66)
  chainId     Int      @map("chain_id")
  quality     Int      @db.SmallInt
  reliability Int      @db.SmallInt
  latency     Int      @map("latency")
  tags        String[] @map("tags")
  reasoning   String?  @map("reasoning")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([agentId])
  @@index([attester])
  @@index([createdAt])
  @@map("eas_attestations")
}
